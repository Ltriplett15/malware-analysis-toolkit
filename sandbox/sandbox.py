import os
import subprocess
import json
import shutil

# Load sandbox settings from the isolation config file
def load_sandbox_config():
    current_dir = os.path.dirname(os.path.abspath(__file__))
    config_file = os.path.join(current_dir, "isolation_config.json")
    
    if not os.path.exists(config_file):
        raise FileNotFoundError(f"Configuration file not found at {config_file}")

    try:
        with open(config_file, 'r') as f:
            config = json.load(f)
    except json.JSONDecodeError as e:
        raise ValueError(f"Error decoding JSON from {config_file}: {e}")
    
    return config

# Load the sandbox configuration
config = load_sandbox_config()
sandbox_dir = config.get('sandbox_directory', 'default/sandbox/path')

# Create an isolated environment for malware analysis
def setup_sandbox(sandbox_dir):
    if not os.path.exists(sandbox_dir):
        os.makedirs(sandbox_dir)
    print(f"[INFO] Sandbox created at {sandbox_dir}")

# Clean up the sandbox after analysis
def clean_sandbox(sandbox_dir):
    try:
        shutil.rmtree(sandbox_dir)
        print(f"[INFO] Sandbox at {sandbox_dir} cleaned up.")
    except Exception as e:
        print(f"[ERROR] Failed to clean sandbox: {e}")

# Run the malware binary in the sandbox
def execute_in_sandbox(malware_path, sandbox_dir, config):
    print(f"[INFO] Executing {malware_path} in the sandbox at {sandbox_dir}")
    
    # Copy malware to the sandbox
    sandbox_malware_path = os.path.join(sandbox_dir, os.path.basename(malware_path))
    try:
        shutil.copy(malware_path, sandbox_malware_path)
        print(f"[INFO] Malware copied to sandbox: {sandbox_malware_path}")
    except FileNotFoundError:
        print(f"[ERROR] Malware file not found: {malware_path}")
        return
    except Exception as e:
        print(f"[ERROR] Failed to copy malware: {e}")
        return
    
    # Execute the malware in the sandbox environment
    try:
        result = subprocess.run([sandbox_malware_path], timeout=config['timeout'])
        print(f"[INFO] Malware executed with exit code: {result.returncode}")
    except subprocess.TimeoutExpired:
        print("[WARNING] Malware execution timed out.")
    except FileNotFoundError:
        print(f"[ERROR] Malware file not found during execution: {sandbox_malware_path}")
    except Exception as e:
        print(f"[ERROR] Failed to execute malware: {e}")

if __name__ == "__main__":
    try:
        config = load_sandbox_config()
        sandbox_dir = config.get('sandbox_directory', 'default/sandbox/path')
        
        malware_path = input("Enter the path to the malware binary: ")
        setup_sandbox(sandbox_dir)
        
        try:
            execute_in_sandbox(malware_path, sandbox_dir, config)
        finally:
            clean_sandbox(sandbox_dir)
    except Exception as e:
        print(f"[ERROR] An error occurred: {e}")
